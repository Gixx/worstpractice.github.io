<!DOCTYPE html><html lang="en">
  <head>
    <meta charset="utf-8">
    <title>How to get the last modified file from an S3 Bucket?&nbsp;-&nbsp;Worst Practice
    </title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1, user-scalable=0">
    <meta name="language" content="en">
    <meta name="robots" content="index,follow">
    <meta name="generator" content="jekyll 3.8.5">
    <meta name="revisit-after" content="7 days">
    <meta name="distribution" content="web">
    <meta name="copyright" content="Copyright © 2022 All rights reserved. Worst Practice.">
    <meta name="description" content="
">
    <meta name="subject" content="">
    <meta name="keywords" content="PHP, AWS, S3 Bucket, Client, ListObjectsV2, Last modified, descending order">
    <!-- facebook share -->
    <meta property="og:locale" content="en_US">
    <meta property="og:site_name" content="Worst Practice">
    <meta property="og:title" content="How to get the last modified file from an S3 Bucket?&nbsp;-&nbsp;Worst Practice
">
    <meta property="og:url" content="https://www.worstpractice.dev/backend/get-the-last-modified-file-from-s3-bucket">
    <meta name="date" content="2021-04-06T16:15:00+00:00">
    <meta property="og:image" content="https://www.worstpractice.dev/assets/img/blog/2021/backend/get-the-last-modified-file-from-s3-bucket/download.jpg">
    <meta property="og:image:width" content="600">
    <meta property="og:image:height" content="600">
    <meta property="og:description" content="Recently I had to make my hands dirty with the AWS S3, and I faced a problem of getting the latest/newest file from a bucket with PHP.">
    <meta property="fb:admins" content="ivan.gabor.80">
    <meta property="fb:app_id" content="2178081495757871">
    <meta property="og:type" content="article">
    <meta property="article:author" content="https://www.facebook.com/ivan.gabor.80">
    <meta property="article:published_time" content="2021-04-06T16:15:00+00:00">
    <meta property="article:tag" content="blog"/>
    <!-- twitter share -->
    <meta name="twitter:title" content="How to get the last modified file from an S3 Bucket?">
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:creator" content="@gaborivan1980">
    <meta name="twitter:description" content="Recently I had to make my hands dirty with the AWS S3, and I faced a problem of getting the latest/newest file from a bucket with PHP.">
    <meta name="twitter:image" content="https://www.worstpractice.dev/assets/img/blog/2021/backend/get-the-last-modified-file-from-s3-bucket/download_600x600.jpg">
    <link rel="canonical" href="https://www.worstpractice.dev">
    <link rel="alternate" type="application/rss+xml" title="How to get the last modified file from an S3 Bucket?&nbsp;-&nbsp;Worst Practice
" href="/feed.xml">
    <link rel="alternate" hreflang="en" href="https://www.worstpractice.dev/backend/get-the-last-modified-file-from-s3-bucket">
    <link rel="apple-touch-icon" sizes="60x60" href="/assets/img/icons/apple-touch-icon-60x60.png">
    <link rel="apple-touch-icon" sizes="76x76" href="/assets/img/icons/apple-touch-icon-76x76.png">
    <link rel="apple-touch-icon" sizes="120x120" href="/assets/img/icons/apple-touch-icon-120x120.png">
    <link rel="apple-touch-icon" sizes="152x152" href="/assets/img/icons/apple-touch-icon-152x152.png">
    <link rel="apple-touch-icon" sizes="180x180" href="/assets/img/icons/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/assets/img/icons/favicon-16x16.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/assets/img/icons/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="192x192" href="/assets/img/icons/android-chrome-192x192.png">
    <link rel="manifest" href="/assets/img/icons/site.webmanifest">
    <link rel="mask-icon" href="/assets/img/icons/safari-pinned-tab.svg" color="#C23F2F">
    <link rel="shortcut icon" href="/assets/img/icons/favicon.ico">
    <meta name="msapplication-TileColor" content="#C23F2F">
    <meta name="msapplication-TileImage" content="/assets/img/icons/mstile-144x144.png">
    <meta name="msapplication-config" content="/assets/img/icons/browserconfig.xml">
    <meta name="theme-color" content="#C23F2F">
    <meta name="application-name" content="Worst Practice Blog">
    <meta name="HandheldFriendly" content="true">
    <meta name="format-detection" content="telephone=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="#C23F2F">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto+Mono:400">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Libre+Baskerville:300,300i,400,400i,700,700i">
    <link rel="stylesheet" href="/assets/css/site.css">
    <script type="application/javascript" src="/assets/js/feature.min.js"></script>
    <script type="application/javascript">
      if (!feature.srcset) {
          window.location.href = '/sorry.html';
      }
    </script>
    <script type="application/javascript" src="/assets/js/site.min.js"></script>
  </head>
  <body>
    <header class="h-header">
      <h1 class="h-header__title"><a href="/">Worst Practice</a></h1>
    </header>
    <div class="codeOfTheDay">
      <input class="codeOfTheDay__toggle" type="checkbox">
      <div class="codeOfTheDay__content"></div>
      <div class="codeOfTheDay__monitor"></div>
      <div class="codeOfTheDay__backdrop"></div>
    </div>
    <div class="m-menu">
      <div class="m-menu__burger">
        <span></span>
      </div>
      <input class="m-menu__toggle" type="checkbox" />
      <div class="m-menu__content">
        <nav>
          <h2 class="m-menu__title">Worst Practice</h2>
          <ul class="m-menu__navigation">
            <li><a class="m-menu__link -home" href="/">Home</a></li>
          </ul>
        </nav>
        <nav>
          <h2 class="m-menu__title">Categories</h2>
          <ul class="m-menu__navigation">
            <li><a class="m-menu__link -frontend" href="/frontend">Frontend</a></li>
            <li><a class="m-menu__link -backend -current" href="/backend">Backend</a></li>
            <li><a class="m-menu__link -wsl" href="/wsl">WSL</a></li>
            <li><a class="m-menu__link -general
" href="/general
">General</a></li>
          </ul>
        </nav>
        <nav>
          <h2 class="m-menu__title">Tags</h2>
          <ul class="m-menu__navigation">
            <li><a class="m-menu__link -personal" rel="tag" href="/tags/personal/">personal <sup>1</sup></a></li>
            <li><a class="m-menu__link -js" rel="tag" href="/tags/js/">JS <sup>4</sup></a></li>
            <li><a class="m-menu__link -webpack" rel="tag" href="/tags/webpack/">Webpack <sup>3</sup></a></li>
          </ul>
          <a class="m-menu__link -more" href="/tags/">More</a>
        </nav>
        <nav>
          <h2 class="m-menu__title">Archive</h2>
          <ul class="m-menu__navigation">
            <li><a class="m-menu__link " href="/archive/2022-11/">November, 2022</a></li>
            <li><a class="m-menu__link " href="/archive/2022-10/">October, 2022</a></li>
            <li><a class="m-menu__link " href="/archive/2021-04/">April, 2021</a></li>
          </ul>
          <a class="m-menu__link -more" href="/archive/">More</a>
        </nav>
        <nav>
          <ul class="m-menu__navigation">
            <li><a class="m-menu__link " href="/imprint.html">Imprint</a></li>
            <li><a class="m-menu__link " href="/terms.html">Terms of Use</a></li>
            <li><a class="m-menu__link " href="/privacy.html">Privacy Policy</a></li>
          </ul>
        </nav>
      </div>
      <div class="m-menu__backdrop"></div>
    </div>
    <main class="c-content">
      <section class="c-content__article">
        <article class="a-article">
          <header class="a-header">
            <h2 class="a-header__title">How to get the last modified file from an S3 Bucket?</h2>
            <div class="a-header__meta">
              <p class="a-meta__date">Posted on April&nbsp; 6, 2021 16:15
              </p>
              <p class="a-meta__category">Posted under the <a href="/backend/index.html">Backend</a> category</p>
              <p class="a-meta__level">Level: beginner</p>
              <p class="a-meta__tags">Posted with the following tags:
                <a href="/tags/php/index.html">#PHP</a>, 
                <a href="/tags/aws/index.html">#AWS</a>, 
                <a href="/tags/s3-bucket/index.html">#S3 Bucket</a>
              </p>
            </div>
          </header>
          <p class="a-excerpt">
            Recently I had to make my hands dirty with the AWS S3, and I faced a problem of getting the latest/newest file from a bucket with PHP.
          </p>
          <figure class="a-illustration">
            <img class="a-illustration__image" src="/assets/img/post-illustration-placeholder.png" data-src="/assets/img/blog/2021/backend/get-the-last-modified-file-from-s3-bucket/download.jpg" alt="How to get the last modified file from an S3 Bucket?">
            <figcaption class="a-illustration__caption"></figcaption>
          </figure>
          <div class="a-body">
            <h3 id="tldr">TL;DR</h3>
            <p>If you don’t want to waste your time reading this tutorial, and you only need a working code sample, please check the source code on
              <a href="https://github.com/Gixx/worstpractice-aws-s3-adapter" target="_blank" rel="noopener">GitHub</a>.</p>
            <h3 id="requirement">Requirement</h3>
            <p>First, it must be nailed down, if you need this regularly, probably it’s better to create a RDS table where you can do such
              queries easily and in a cost/CPU/time effective way.</p>
            <p>This method is the opposite. It gets the full list from an S3 bucket, and then sort and filter on the local backend. Far from 
              optimal.</p>
            <p>I assume those looking for this code snippet has already some kind of access to the <a target="_blank" rel="noopener" href="https://aws.amazon.com/s3/">Amazon S3</a>
              and also has the keys and credentials for the AWS SDK S3 Client script to access it from their application.</p>
            <h3 id="the-adapter">The Adapter</h3>
            <p>I’m a PHP developer, so I will show how to do this in PHP. First I define some constants that we will need later:</p>
            <div class="language-php highlighter-rouge">
              <div class="highlight">
                <pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
</pre>
              </td>
              <td class="rouge-code">
                <pre><span class="cp">&lt;?php</span>

<span class="k">declare</span><span class="p">(</span><span class="n">strict_types</span><span class="o">=</span><span class="mi">1</span><span class="p">);</span>

<span class="kn">namespace</span> <span class="nn">WorstPractice\Component\Aws\S3</span><span class="p">;</span>

<span class="kd">class</span> <span class="nc">Adapter</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">const</span> <span class="no">AWS_DEFAULT_LIST_LIMIT</span> <span class="o">=</span> <span class="mi">1000</span><span class="p">;</span>

    <span class="k">public</span> <span class="k">const</span> <span class="no">OBJECT_SORT_BY_NAME</span> <span class="o">=</span> <span class="s1">'^Key'</span><span class="p">;</span>
    <span class="k">public</span> <span class="k">const</span> <span class="no">OBJECT_SORT_BY_NAME_DESC</span> <span class="o">=</span> <span class="s1">'vKey'</span><span class="p">;</span>
    <span class="k">public</span> <span class="k">const</span> <span class="no">OBJECT_SORT_BY_DATE</span> <span class="o">=</span> <span class="s1">'^LastModified'</span><span class="p">;</span>
    <span class="k">public</span> <span class="k">const</span> <span class="no">OBJECT_SORT_BY_DATE_DESC</span> <span class="o">=</span> <span class="s1">'vLastModified'</span><span class="p">;</span>
<span class="p">}</span>
</pre>
              </td>
            </tr>
          </tbody>
        </table>
      </code></pre>
  </div>
</div>
<p>The <code class="language-plaintext highlighter-rouge">AWS_DEFAULT_LIST_LIMIT</code> is the default value the <code class="language-plaintext highlighter-rouge">MaxKeys</code> limiter of the requested list. If there are more objects 
  in the given S3 bucket, it will return chunks. I believe the developers at AWS know why this value is the best, so I didn’t 
  change it. If I make it smaller, the more chunks I have to request, if I make it bigger it may hit the response time. So 
  the default limit is just fine.</p>
<p>Then I defined four constants for control the sorting. By default the objects are returned sorted in an ascending order 
  of the respective key names in the list, and currently there’s no official AWS way to change this sort. So we have to do 
  it locally.</p>
<p>I don’t like to put too complex logic to determine the key and sort direction, so I mixed the two using some semi-visual
  markers. Before the key name, I use either <code class="language-plaintext highlighter-rouge">^</code> or <code class="language-plaintext highlighter-rouge">v</code> to know if it’s a ascending (<code class="language-plaintext highlighter-rouge">^</code> or “up”) or a descending (<code class="language-plaintext highlighter-rouge">v</code> or 
  down) order.</p>
<h4 id="the-constructor">The constructor</h4>
<p>To <strong>instantiate</strong> the adapter, we need to pass the AWS S3 Client object, so it can communicate with the AWS when needed.</p>
<div class="language-php highlighter-rouge">
  <div class="highlight">
    <pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
</pre>
  </td>
  <td class="rouge-code">
    <pre><span class="c1">//...</span>

<span class="kn">use</span> <span class="nc">Aws\S3\S3Client</span><span class="p">;</span>

<span class="kd">class</span> <span class="nc">Adapter</span>
<span class="p">{</span>
    <span class="c1">// ...</span>
    
    <span class="k">public</span> <span class="k">function</span> <span class="n">__construct</span><span class="p">(</span><span class="kt">private</span> <span class="nc">S3Client</span> <span class="nv">$s3Client</span><span class="p">)</span>
    <span class="p">{</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre>
  </td>
</tr>
</tbody>
</table>
</code></pre>
</div>
</div>
<p>I love the new features of the PHP8, for example this constructor property promotion simplifies a lot on the code.</p>
<h4 id="specify-the-bucket">Specify the bucket</h4>
<p>To <strong>use</strong> the different S3 Client actions, in most cases we need to specify the <strong>bucket</strong> we want to work with. To avoid
  unnecessary parameters, and assuming that one wants to work on the same bucket, we decouple this setting from the
  constructor into a separate public method:</p>
<div class="language-php highlighter-rouge">
  <div class="highlight">
    <pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
</pre>
  </td>
  <td class="rouge-code">
    <pre><span class="c1">// ...</span>

<span class="kd">class</span> <span class="nc">Adapter</span>
<span class="p">{</span>
    <span class="c1">// ...</span>
    
    <span class="k">private</span> <span class="kt">string</span> <span class="nv">$bucket</span><span class="p">;</span>
    
    <span class="c1">// ...</span>
    
    <span class="k">public</span> <span class="k">function</span> <span class="n">setBucket</span><span class="p">(</span><span class="kt">string</span> <span class="nv">$bucket</span><span class="p">):</span> <span class="kt">void</span>
    <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">bucket</span> <span class="o">=</span> <span class="nv">$bucket</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre>
  </td>
</tr>
</tbody>
</table>
</code></pre>
</div>
</div>
<h4 id="get-the-buckets-object-list">Get the bucket’s object list</h4>
<p>In an S3 bucket we don’t talk about files, we talk about objects. An object holds various metadata like ID, key, date of 
  modification, the filesize etc. That’s why the sorting is so difficult, and if you need a frequently used sorting, I yet 
  again recommend You to create a table in a relational database to solve it there.</p>
<p>To get the <code class="language-plaintext highlighter-rouge">last modified file from an S3 Bucket</code> we need to do four things:</p>
<ol>
  <li>set up the search options and additionally change the sort and limit arguments</li>
  <li>get the full bucket object list (filtered by prefix)</li>
  <li>apply the sorting on the full list (sort by “date modified” in descending order)</li>
  <li>get the first element and return the object’s key that we need to get the file.</li>
</ol>
<p>It looks as the following:</p>
<div class="language-php highlighter-rouge">
  <div class="highlight">
    <pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
</pre>
  </td>
  <td class="rouge-code">
    <pre><span class="c1">// ...</span>

<span class="kd">class</span> <span class="nc">Adapter</span>
<span class="p">{</span>
    <span class="c1">// ...</span>
    
    <span class="k">public</span> <span class="k">function</span> <span class="n">getObjectListByPrefix</span><span class="p">(</span><span class="kt">string</span> <span class="nv">$keyPrefix</span><span class="p">,</span> <span class="kt">string</span> <span class="nv">$sortBy</span> <span class="o">=</span> <span class="kc">null</span><span class="p">,</span> <span class="kt">int</span> <span class="nv">$limit</span> <span class="o">=</span> <span class="mi">0</span><span class="p">):</span> <span class="kt">array</span>
    <span class="p">{</span>
        <span class="nv">$options</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">getSearchOptions</span><span class="p">(</span><span class="nv">$keyPrefix</span><span class="p">,</span> <span class="nv">$sortBy</span><span class="p">,</span> <span class="nv">$limit</span><span class="p">);</span>

        <span class="nv">$results</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">fetchFullFileList</span><span class="p">(</span><span class="nv">$options</span><span class="p">);</span>
        <span class="c1">// Avoid sort if not needed.</span>
        <span class="nv">$sortBy</span> <span class="o">!==</span> <span class="k">self</span><span class="o">::</span><span class="no">OBJECT_SORT_BY_NAME</span> <span class="o">&amp;&amp;</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">sortFileList</span><span class="p">(</span><span class="nv">$results</span><span class="p">,</span> <span class="nv">$sortBy</span><span class="p">);</span>
        <span class="c1">// Avoid limit if not needed.</span>
        <span class="nv">$limit</span> <span class="o">&amp;&amp;</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">limitFileList</span><span class="p">(</span><span class="nv">$results</span><span class="p">,</span> <span class="nv">$limit</span><span class="p">);</span>

        <span class="k">return</span> <span class="nv">$results</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre>
  </td>
</tr>
</tbody>
</table>
</code></pre>
</div>
</div>
<p>First we setup the basic options array for the request. If we use the default sort by value, we can skip the expensive 
  process of custom sorting on PHP side. Also if the limit is equal to zero, we can skip the additional method call.</p>
<p>Now let’s see the these methods</p>
<h4 id="the-search-options">The search options</h4>
<p>Here we set up the basic options array, and if necessary change the <code class="language-plaintext highlighter-rouge">$sortBy</code> and <code class="language-plaintext highlighter-rouge">$limit</code> parameters:</p>
<ul>
  <li>If the sortBy was not set, set the default one. I could have added a constant for it, but didn’t feel necessary.</li>
  <li>If the limit is a negative number, we consider it as a soft mistake and use the absolute value of it. I could have 
    use the negative limit to control the direction of the sort, but it would have added an unnecessary complexity.</li>
</ul>
<p>Then we check if the given sort-by parameter is the default AWS S3 sorting. We can use this information to add an AWS 
  side result limiter, and if the limit is lower than the default AWS list limit (<code class="language-plaintext highlighter-rouge">MaxKeys</code>). It’s good for the performance.</p>
<div class="language-php highlighter-rouge">
  <div class="highlight">
    <pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
</pre>
  </td>
  <td class="rouge-code">
    <pre><span class="c1">// ...</span>

<span class="kd">class</span> <span class="nc">Adapter</span>
<span class="p">{</span>
    <span class="c1">// ...</span>
    <span class="k">private</span> <span class="k">function</span> <span class="n">getSearchOptions</span><span class="p">(</span><span class="kt">string</span> <span class="nv">$keyPrefix</span><span class="p">,</span> <span class="kt">?string</span> <span class="o">&amp;</span><span class="nv">$sortBy</span><span class="p">,</span> <span class="kt">int</span> <span class="o">&amp;</span><span class="nv">$limit</span><span class="p">):</span> <span class="kt">array</span>
    <span class="p">{</span>
        <span class="nv">$options</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s1">'Bucket'</span> <span class="o">=&gt;</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">bucket</span><span class="p">,</span>
            <span class="s1">'EncodingType'</span> <span class="o">=&gt;</span> <span class="s1">'url'</span><span class="p">,</span>
            <span class="s1">'Prefix'</span> <span class="o">=&gt;</span> <span class="nv">$keyPrefix</span><span class="p">,</span>
            <span class="s1">'RequestPayer'</span> <span class="o">=&gt;</span> <span class="s1">'requester'</span>
        <span class="p">];</span>

        <span class="k">if</span> <span class="p">(</span><span class="nb">empty</span><span class="p">(</span><span class="nv">$sortBy</span><span class="p">))</span> <span class="p">{</span>
            <span class="nv">$sortBy</span> <span class="o">=</span> <span class="k">self</span><span class="o">::</span><span class="no">OBJECT_SORT_BY_NAME</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="nv">$limit</span> <span class="o">=</span> <span class="p">(</span><span class="n">int</span><span class="p">)</span> <span class="nb">abs</span><span class="p">(</span><span class="nv">$limit</span><span class="p">);</span>

        <span class="c1">// We can add a query limit here only when we don't want any special sorting.</span>
        <span class="k">if</span> <span class="p">(</span><span class="nv">$sortBy</span> <span class="o">===</span> <span class="k">self</span><span class="o">::</span><span class="no">OBJECT_SORT_BY_NAME</span> <span class="o">&amp;&amp;</span> <span class="nv">$limit</span> <span class="o">&lt;</span> <span class="k">self</span><span class="o">::</span><span class="no">AWS_DEFAULT_LIST_LIMIT</span><span class="p">)</span> <span class="p">{</span>
            <span class="nv">$options</span><span class="p">[</span><span class="s1">'MaxKeys'</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$limit</span><span class="p">;</span>
            <span class="c1">// Set the parameter to 0 to avoid the unnecessary array_chunk later.</span>
            <span class="nv">$limit</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="nv">$options</span><span class="p">;</span>
    <span class="p">}</span>   
<span class="p">}</span>
</pre>
  </td>
</tr>
</tbody>
</table>
</code></pre>
</div>
</div>
<p>Note, we added a <code class="language-plaintext highlighter-rouge">Prefix</code> index to the options. In an S3 bucket the <em>prefix</em> is something like a path on the filesystem. 
  Generally it can be anything that is part of the beginning of the object’s key, but with slashes (<code class="language-plaintext highlighter-rouge">/</code>), the S3 console on
  the AWS website will consider them as “folders”. This will help a lot when we request file list under a specific “sub-folder”.</p>
<h4 id="the-requester">The requester</h4>
<p>Here we communicate with the AWS through the S3 Client provided by the AWS SDK. In this method we have to heavily build
  on the <a target="_blank" rel="noopener" href="https://docs.aws.amazon.com/aws-sdk-php/v3/api/class-Aws.S3.S3Client.html">SDK documentation</a>, 
  So we have to believe what is written there:</p>
<ul>
  <li>It there is no result, then the <code class="language-plaintext highlighter-rouge">Contents</code> index is empty in the response array.</li>
  <li>Otherwise the all the required indexes <strong>must</strong> exist.</li>
</ul>
<p>Getting a full bucket list is a little bit tricky. We need to keep requesting the AWS, until we get all the objects, then
  merge the results into one array.</p>
<p>To achieve this, the best option is the <code class="language-plaintext highlighter-rouge">do ... while</code> loop.</p>
<div class="language-php highlighter-rouge">
  <div class="highlight">
    <pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
</pre>
  </td>
  <td class="rouge-code">
    <pre><span class="c1">// ...</span>

<span class="kd">class</span> <span class="nc">Adapter</span>
<span class="p">{</span>
    <span class="c1">// ...</span>
    
    <span class="k">private</span> <span class="k">function</span> <span class="n">fetchFullFileList</span><span class="p">(</span><span class="kt">array</span> <span class="nv">$options</span><span class="p">):</span> <span class="kt">array</span>
    <span class="p">{</span>
        <span class="nv">$results</span> <span class="o">=</span> <span class="p">[];</span>
        <span class="nv">$continuationToken</span> <span class="o">=</span> <span class="s1">''</span><span class="p">;</span>

        <span class="k">do</span> <span class="p">{</span>
            <span class="nv">$options</span><span class="p">[</span><span class="s1">'ContinuationToken'</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$continuationToken</span><span class="p">;</span>

            <span class="nv">$response</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">s3Client</span><span class="o">-&gt;</span><span class="nf">listObjectsV2</span><span class="p">(</span><span class="nv">$options</span><span class="p">);</span>

            <span class="k">if</span> <span class="p">(</span><span class="nb">empty</span><span class="p">(</span><span class="nv">$response</span><span class="p">[</span><span class="s1">'Contents'</span><span class="p">]))</span> <span class="p">{</span>
                <span class="k">break</span><span class="p">;</span>
            <span class="p">}</span>

            <span class="nv">$results</span><span class="p">[]</span> <span class="o">=</span> <span class="nv">$response</span><span class="p">[</span><span class="s1">'Contents'</span><span class="p">];</span>
            <span class="nv">$continuationToken</span> <span class="o">=</span> <span class="nv">$response</span><span class="p">[</span><span class="s1">'NextContinuationToken'</span><span class="p">];</span>
            <span class="nv">$isTruncated</span> <span class="o">=</span> <span class="nv">$response</span><span class="p">[</span><span class="s1">'IsTruncated'</span><span class="p">];</span>
            <span class="nb">usleep</span><span class="p">(</span><span class="mi">50000</span><span class="p">);</span> <span class="c1">// 50 ms pause to avoid CPU spikes</span>
        <span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="nv">$isTruncated</span><span class="p">);</span>

        <span class="k">return</span> <span class="nb">array_merge</span><span class="p">([],</span> <span class="mf">...</span><span class="nv">$results</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre>
  </td>
</tr>
</tbody>
</table>
</code></pre>
</div>
</div>
<p>I’m always happy when I can use a <code class="language-plaintext highlighter-rouge">do ... while</code>, it’s a kind of rare occasion.</p>
<p>In the loop we get actual portion of the list. The <code class="language-plaintext highlighter-rouge">ContinuationToken</code> tells the AWS where it should continue the listing.
  For the first time, this token is empty, so the AWS will start in the beginning. In the response we get the 
  <code class="language-plaintext highlighter-rouge">NextContinuationToken</code> which points to the next portion. We call again the AWS with this token unless the <code class="language-plaintext highlighter-rouge">isTruncated</code>
  flag is <code class="language-plaintext highlighter-rouge">TRUE</code> which means we reached the end of the list.</p>
<p>A general rule is to avoid <code class="language-plaintext highlighter-rouge">array_merge</code> within loops. Then how to collect all the data into a list without it or adding
  another loop, like <code class="language-plaintext highlighter-rouge">foreach</code>? Here is an optimization advice:</p>
<blockquote>
  <p>Collect the result arrays into an array, and after the loop simple merge them with the help of the <strong>splat
      operator</strong>.</p>
</blockquote>
<p>Actually this part:</p>
<div class="language-php highlighter-rouge">
  <div class="highlight">
    <pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre>
  </td>
  <td class="rouge-code">
    <pre><span class="nb">array_merge</span><span class="p">([],</span> <span class="mf">...</span><span class="nv">$results</span><span class="p">);</span>
</pre>
  </td>
</tr>
</tbody>
</table>
</code></pre>
</div>
</div>
<p>Here we use the <code class="language-plaintext highlighter-rouge">splat operator</code> (<code class="language-plaintext highlighter-rouge">...</code>) for “unpacking the argument”. Since we are sure that every element of the <code class="language-plaintext highlighter-rouge">$results</code>
  array are arrays too, we can bravely unpack it and pass all its items (arrays) to the <code class="language-plaintext highlighter-rouge">array_merge</code>. But since we need 
  to explicitly add two arrays, we use an empty array as a starting. The <code class="language-plaintext highlighter-rouge">array_merge</code> then merges all the arrays within 
  the <code class="language-plaintext highlighter-rouge">$results</code> with this empty array, and what we get is the full object list on an AWS S3 bucket starting with a specific 
  prefix.</p>
<h4 id="the-sorter">The sorter</h4>
<p>The next method is the <code class="language-plaintext highlighter-rouge">sortFileList</code>. We call it only when want other than the default sort.
  This method gives us a great opportunity to practice the custom sorting ability of PHP. First we need to check if we 
  need ascending or descending sort. As I wrote earlier, the first character should tell this. To avoid mistakes, we can 
  add a simple validator for the available sorting values too.</p>
<div class="language-php highlighter-rouge">
  <div class="highlight">
    <pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
</pre>
  </td>
  <td class="rouge-code">
    <pre><span class="c1">// ...</span>

<span class="kd">class</span> <span class="nc">Adapter</span>
<span class="p">{</span>
    <span class="c1">// ...</span>
    
    <span class="k">private</span> <span class="kt">array</span> <span class="nv">$validSortByKeys</span> <span class="o">=</span> <span class="p">[</span>
        <span class="k">self</span><span class="o">::</span><span class="no">OBJECT_SORT_BY_NAME</span><span class="p">,</span>
        <span class="k">self</span><span class="o">::</span><span class="no">OBJECT_SORT_BY_NAME_DESC</span><span class="p">,</span>
        <span class="k">self</span><span class="o">::</span><span class="no">OBJECT_SORT_BY_DATE</span><span class="p">,</span>
        <span class="k">self</span><span class="o">::</span><span class="no">OBJECT_SORT_BY_DATE_DESC</span><span class="p">,</span>
    <span class="p">];</span>
    
    <span class="c1">// ...</span>
    
    <span class="k">private</span> <span class="k">function</span> <span class="n">sortFileList</span><span class="p">(</span><span class="kt">array</span> <span class="o">&amp;</span><span class="nv">$fileList</span><span class="p">,</span> <span class="kt">?string</span> <span class="nv">$sortBy</span><span class="p">):</span> <span class="kt">bool</span>
    <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">empty</span><span class="p">(</span><span class="nv">$fileList</span><span class="p">)</span> <span class="o">||</span> <span class="nb">empty</span><span class="p">(</span><span class="nv">$sortBy</span><span class="p">)</span> <span class="o">||</span> <span class="o">!</span><span class="nb">in_array</span><span class="p">(</span><span class="nv">$sortBy</span><span class="p">,</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">validSortByKeys</span><span class="p">,</span> <span class="kc">true</span><span class="p">))</span> <span class="p">{</span>
            <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="nv">$direction</span> <span class="o">=</span> <span class="nv">$sortBy</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">===</span> <span class="s1">'^'</span> <span class="o">?</span> <span class="s1">'asc'</span> <span class="o">:</span> <span class="s1">'desc'</span><span class="p">;</span>
        <span class="nv">$sortByKey</span> <span class="o">=</span> <span class="nb">substr</span><span class="p">(</span><span class="nv">$sortBy</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

        <span class="k">return</span> <span class="nb">usort</span><span class="p">(</span><span class="nv">$fileList</span><span class="p">,</span> <span class="k">static</span> <span class="k">function</span> <span class="p">(</span><span class="nv">$a</span><span class="p">,</span> <span class="nv">$b</span><span class="p">)</span> <span class="k">use</span> <span class="p">(</span><span class="nv">$direction</span><span class="p">,</span> <span class="nv">$sortByKey</span><span class="p">)</span> <span class="p">{</span>
            <span class="nv">$cmp</span> <span class="o">=</span> <span class="nb">strcmp</span><span class="p">(</span><span class="nv">$a</span><span class="p">[</span><span class="nv">$sortByKey</span><span class="p">],</span> <span class="nv">$b</span><span class="p">[</span><span class="nv">$sortByKey</span><span class="p">]);</span>
            <span class="k">return</span> <span class="nv">$direction</span> <span class="o">===</span> <span class="s1">'asc'</span> <span class="o">?</span> <span class="nv">$cmp</span> <span class="o">:</span> <span class="o">-</span><span class="nv">$cmp</span><span class="p">;</span>
        <span class="p">});</span>
    <span class="p">}</span>    
<span class="p">}</span>
</pre>
  </td>
</tr>
</tbody>
</table>
</code></pre>
</div>
</div>
<p>If you are not familiar with the custom sort in PHP, this is how it works. The <a target="_blank" rel="noopener" href="https://www.php.net/manual/en/function.usort.php"><code class="language-plaintext highlighter-rouge">usort</code></a>
  function gets the array that needs to be sorted as a reference parameter. This means the function will change the parameter 
  itself and doesn’t return a new version of it as other array functions do like the <a target="_blank" rel="noopener" href="https://www.php.net/manual/en/function.array-replace.php"><code class="language-plaintext highlighter-rouge">array_replace</code></a>.</p>
<p>The second parameter is a callback function, that gets two actual elements from the array. We don’t need to know where are
  these placed in the original array, the <code class="language-plaintext highlighter-rouge">usort</code> calls this, not us. We only need to define the logic, that decides the 
  relation between the two items. Return <code class="language-plaintext highlighter-rouge">-1</code> if the first argument is considered to be respectively less than, <code class="language-plaintext highlighter-rouge">0</code> if it is 
  equal to, or <code class="language-plaintext highlighter-rouge">1</code> if it is greater than the second parameter.</p>
<p>With the <code class="language-plaintext highlighter-rouge">use</code> statement, we can “inject” variables into the function’s scope. This way we can control if the “greater”
  should be <code class="language-plaintext highlighter-rouge">1</code> or <code class="language-plaintext highlighter-rouge">-1</code> therefore apply the ascending and descending order without an extra <code class="language-plaintext highlighter-rouge">array_reverse</code> call.</p>
<h4 id="the-result-limiter">The result limiter</h4>
<p>This is the simplest: the result must be an array. If it’s not empty, then just chunk the array into pieces with the size
  of the <code class="language-plaintext highlighter-rouge">limit</code> and return the first chunk.</p>
<div class="language-php highlighter-rouge">
  <div class="highlight">
    <pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
</pre>
  </td>
  <td class="rouge-code">
    <pre><span class="c1">// ...</span>

<span class="kd">class</span> <span class="nc">Adapter</span>
<span class="p">{</span>
    <span class="c1">// ...</span>
    
    <span class="k">private</span> <span class="k">function</span> <span class="n">limitFileList</span><span class="p">(</span><span class="kt">array</span> <span class="o">&amp;</span><span class="nv">$fileList</span><span class="p">,</span> <span class="kt">int</span> <span class="nv">$limit</span><span class="p">):</span> <span class="kt">bool</span>
    <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">empty</span><span class="p">(</span><span class="nv">$fileList</span><span class="p">)</span> <span class="o">||</span> <span class="nv">$limit</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="nv">$fileList</span> <span class="o">=</span> <span class="nb">array_chunk</span><span class="p">(</span><span class="nv">$fileList</span><span class="p">,</span> <span class="nv">$limit</span><span class="p">)[</span><span class="mi">0</span><span class="p">];</span>

        <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre>
  </td>
</tr>
</tbody>
</table>
</code></pre>
</div>
</div>
<h4 id="get-the-last-modified-files-key">Get the last modified file’s key</h4>
<p>After having the method getting the full list sorted and chunked, the base problem of this topic is as simple as is:
  calling our method with the right parameters. Or we can create a method just for this special case.</p>
<div class="language-php highlighter-rouge">
  <div class="highlight">
    <pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
</pre>
  </td>
  <td class="rouge-code">
    <pre><span class="c1">// ...</span>

<span class="kd">class</span> <span class="nc">Adapter</span>
<span class="p">{</span>
    <span class="c1">// ...</span>
    
    <span class="k">public</span> <span class="k">function</span> <span class="n">getLastUploadedKeyByPrefix</span><span class="p">(</span><span class="kt">string</span> <span class="nv">$keyPrefix</span><span class="p">):</span> <span class="kt">?string</span>
    <span class="p">{</span>
        <span class="nv">$object</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">getObjectListByPrefix</span><span class="p">(</span><span class="nv">$keyPrefix</span><span class="p">,</span> <span class="k">self</span><span class="o">::</span><span class="no">OBJECT_SORT_BY_DATE_DESC</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

        <span class="k">return</span> <span class="nv">$object</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">'Key'</span><span class="p">]</span> <span class="o">??</span> <span class="kc">null</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre>
  </td>
</tr>
</tbody>
</table>
</code></pre>
</div>
</div>
<p>This will return a string with the file’s key on the S3 bucket, or <code class="language-plaintext highlighter-rouge">NULL</code> if the bucket with the given prefix is empty.
  You can also create a method that downloads the file from the S3 bucket, but let it be a homework.</p>
</div>
<footer class="a-footer">
  <h3 class="a-footer__title">About the author</h3>
  <a class="a-footer__avatar" href="/author/gabor.ivan/index.html"><img src="/author/gabor.ivan/avatar.jpg" alt="Gábor Iván"></a>
  <p class="a-footer__author">
    Hi, my name is Gábor Iván. I am an old-school Full stack developer, which means I deal with Backend (PHP), Frontend (HTML, CSS, JS), and a little bit of Webdesign. No DevOPS, sorry.
    <br>
    <a href="/author/gabor.ivan/index.html">Read the full story</a>
  </p>
</footer>
</article>
<aside class="a-comments">
  <header class="a-comments__title">
    <h4>It's time to judge me!</h4>
  </header>
  <div id="general">
    There's no embedded tool to judge me in public. But don't worry, you can
    <a class="mailto" href="&#109;&#97;&#105;&#108;&#116;&#111;&#58;&#119;&#111;&#114;&#115;&#116;&#46;&#112;&#114;&#97;&#99;&#116;&#105;&#99;&#101;&#46;&#98;&#108;&#111;&#103;&#64;&#103;&#109;&#97;&#105;&#108;&#46;&#99;&#111;&#109;?subject=Judgement on `How to get the last modified file from an S3 Bucket?`" target="_blank" rel="noopener" rel="noopener noreferrer">write me</a>
    your opinions/ideas/suggestions in email. Please don't forget to reference the page in the message.
  </div>
</aside>
</section>
</main>
<footer class="f-footer">
  <p class="f-footer__copyright">
    <small>Copyright © 2022 All rights reserved. Worst Practice</small>
  </p>
</footer>
</body>
</html>